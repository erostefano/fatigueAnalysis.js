<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlazeFace Video Stream</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #video {
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<h1>BlazeFace Face Detection in Video Stream</h1>
<video id="video" width="640" height="480" autoplay></video>
<br>
<img id="croppedFace" width="300" alt="Cropped Face">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
<script>
    let video;
    let model;

    async function setupCamera() {
        video = document.getElementById('video');
        const stream = await navigator.mediaDevices.getUserMedia({
            video: true
        });
        video.srcObject = stream;
        return new Promise(resolve => {
            video.onloadedmetadata = () => {
                resolve();
            };
        });
    }

    async function setupModel() {
        model = await blazeface.load();
    }

    async function detectFace() {
        const predictions = await model.estimateFaces(video, false);

        if (predictions.length > 0) {
            const [prediction] = predictions;
            const {topLeft, bottomRight} = prediction;
            const x = Math.max(topLeft[0], 0);
            const y = Math.max(topLeft[1], 0);
            const width = bottomRight[0] - x;
            const height = bottomRight[1] - y;

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const context = canvas.getContext('2d');
            context.drawImage(video, x, y, width, height, 0, 0, width, height);

            const croppedFace = document.getElementById('croppedFace');
            croppedFace.src = canvas.toDataURL();
        }

        requestAnimationFrame(detectFace);
    }

    async function main() {
        await setupCamera();
        await setupModel();
        detectFace();
    }

    main();
</script>
</body>
</html>
